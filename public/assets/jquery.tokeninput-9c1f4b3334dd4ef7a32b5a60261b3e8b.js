/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.5.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
(function(a){var b={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,idPrefix:"token-input-"},c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},d={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},f={init:function(c,d){var e=a.extend({},b,d||{});return this.each(function(){a(this).data("tokenInputObject",new a.TokenList(this,c,e))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(a){return this.data("tokenInputObject").add(a),this},remove:function(a){return this.data("tokenInputObject").remove(a),this}};a.fn.tokenInput=function(a){return f[a]?f[a].apply(this,Array.prototype.slice.call(arguments,1)):f.init.apply(this,arguments)},a.TokenList=function(b,f,g){function w(){if(g.tokenLimit!==null&&i>=g.tokenLimit){m.hide(),F();return}m.focus()}function x(){if(l===(l=m.val()))return;var a=l.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");u.html(a),m.width(u.width()+30)}function y(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function z(b){var c=a("<li><p>"+b.name+"</p></li>").addClass(g.classes.token).insertBefore(s);a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(c).click(function(){return E(a(this).parent()),!1});var d={id:b.id,name:b.name};a.data(c.get(0),"tokeninput",b),h=h.slice(0,p).concat([d]).concat(h.slice(p)),p++;var e=a.map(h,function(a){return a.id});return n.val(e.join(g.tokenDelimiter)),i+=1,c}function A(b){var c=g.onAdd;if(i>0&&g.preventDuplicates){var d=null;r.children().each(function(){var c=a(this),e=a.data(c.get(0),"tokeninput");if(e&&e.id===b.id)return d=c,!1});if(d){B(d),s.insertAfter(d),m.focus();return}}z(b),w(),m.val(""),F(),a.isFunction(c)&&c.call(n,b)}function B(a){a.addClass(g.classes.selectedToken),o=a.get(0),m.val(""),F()}function C(a,b){a.removeClass(g.classes.selectedToken),o=null,b===d.BEFORE?(s.insertBefore(a),p--):b===d.AFTER?(s.insertAfter(a),p++):(s.appendTo(r),p=i),m.focus()}function D(b){var c=o;o&&C(a(o),d.END),c===b.get(0)?C(b,d.END):B(b)}function E(b){var c=a.data(b.get(0),"tokeninput"),d=g.onDelete,e=b.prevAll().length;e>p&&e--,b.remove(),o=null,m.focus(),h=h.slice(0,e).concat(h.slice(e+1)),e<p&&p--;var f=a.map(h,function(a){return a.id});n.val(f.join(g.tokenDelimiter)),i-=1,g.tokenLimit!==null&&m.show().val("").focus(),a.isFunction(d)&&d.call(n,c)}function F(){t.hide().empty(),q=null}function G(){t.css({position:"absolute",top:a(r).offset().top+a(r).outerHeight(),left:a(r).offset().left,zindex:9999}).show()}function H(){g.searchingText&&(t.html("<p>"+g.searchingText+"</p>"),G())}function I(){g.hintText&&(t.html("<p>"+g.hintText+"</p>"),G())}function J(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function K(b,c){if(c&&c.length){t.empty();var d=a("<ul>").appendTo(t).mouseover(function(b){L(a(b.target).closest("li"))}).mousedown(function(b){return A(a(b.target).closest("li").data("tokeninput")),!1}).hide();a.each(c,function(c,e){var f=a("<li>"+J(e.name,b)+"</li>").appendTo(d);c%2?f.addClass(g.classes.dropdownItem):f.addClass(g.classes.dropdownItem2),c===0&&L(f),a.data(f.get(0),"tokeninput",e)}),G(),g.animateDropdown?d.slideDown("fast"):d.show()}else g.noResultsText&&(t.html("<p>"+g.noResultsText+"</p>"),G())}function L(b){b&&(q&&M(a(q)),b.addClass(g.classes.selectedDropdownItem),q=b.get(0))}function M(a){a.removeClass(g.classes.selectedDropdownItem),q=null}function N(){var b=m.val().toLowerCase();b&&b.length&&(o&&C(a(o),d.AFTER),b.length>=g.minChars?(H(),clearTimeout(k),k=setTimeout(function(){O(b)},g.searchDelay)):F())}function O(b){var c=j.get(b);if(c)K(b,c);else if(g.url){var d={};d.data={};if(g.url.indexOf("?")>-1){var e=g.url.split("?");d.url=e[0];var f=e[1].split("&");a.each(f,function(a,b){var c=b.split("=");d.data[c[0]]=c[1]})}else d.url=g.url;d.data[g.queryParam]=b,d.type=g.method,d.dataType=g.contentType,g.crossDomain&&(d.dataType="jsonp"),d.success=function(c){a.isFunction(g.onResult)&&(c=g.onResult.call(n,c)),j.add(b,g.jsonContainer?c[g.jsonContainer]:c),m.val().toLowerCase()===b&&K(b,g.jsonContainer?c[g.jsonContainer]:c)},a.ajax(d)}else if(g.local_data){var h=a.grep(g.local_data,function(a){return a.name.toLowerCase().indexOf(b.toLowerCase())>-1});a.isFunction(g.onResult)&&(h=g.onResult.call(n,h)),j.add(b,h),K(b,h)}}typeof f=="string"?(g.url=f,g.crossDomain===undefined&&(g.url.indexOf("://")===-1?g.crossDomain=!1:g.crossDomain=location.href.split(/\/+/g)[1]!==g.url.split(/\/+/g)[1])):typeof f=="object"&&(g.local_data=f),g.classes?g.classes=a.extend({},c,g.classes):g.theme?(g.classes={},a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})):g.classes=c;var h=[],i=0,j=new a.TokenList.Cache,k,l,m=a('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",g.idPrefix+b.id).focus(function(){(g.tokenLimit===null||g.tokenLimit!==i)&&I()}).blur(function(){F(),a(this).val("")}).bind("keyup keydown blur update",x).keydown(function(b){var c,f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!a(this).val())c=s.prev(),f=s.next(),c.length&&c.get(0)===o||f.length&&f.get(0)===o?b.keyCode===e.LEFT||b.keyCode===e.UP?C(a(o),d.BEFORE):C(a(o),d.AFTER):b.keyCode!==e.LEFT&&b.keyCode!==e.UP||!c.length?(b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length&&B(a(f.get(0))):B(a(c.get(0)));else{var g=null;return b.keyCode===e.DOWN||b.keyCode===e.RIGHT?g=a(q).next():g=a(q).prev(),g.length&&L(g),!1}break;case e.BACKSPACE:c=s.prev();if(!a(this).val().length)return o?E(a(o)):c.length&&B(a(c.get(0))),!1;a(this).val().length===1?F():setTimeout(function(){N()},5);break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(q)return A(a(q).data("tokeninput")),!1;break;case e.ESCAPE:return F(),!0;default:String.fromCharCode(b.which)&&setTimeout(function(){N()},5)}}),n=a(b).hide().val("").focus(function(){m.focus()}).blur(function(){m.blur()}),o=null,p=0,q=null,r=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");c&&c.get(0)&&a.data(c.get(0),"tokeninput")?D(c):(o&&C(a(o),d.END),m.focus())}).mouseover(function(b){var c=a(b.target).closest("li");c&&o!==this&&c.addClass(g.classes.highlightedToken)}).mouseout(function(b){var c=a(b.target).closest("li");c&&o!==this&&c.removeClass(g.classes.highlightedToken)}).insertBefore(n),s=a("<li />").addClass(g.classes.inputToken).appendTo(r).append(m),t=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide(),u=a("<tester/>").insertAfter(m).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:m.css("fontSize"),fontFamily:m.css("fontFamily"),fontWeight:m.css("fontWeight"),letterSpacing:m.css("letterSpacing"),whiteSpace:"nowrap"});n.val("");var v=g.prePopulate||n.data("pre");g.processPrePopulate&&a.isFunction(g.onResult)&&(v=g.onResult.call(n,v)),v&&v.length&&a.each(v,function(a,b){z(b),w()}),this.clear=function(){r.children("li").each(function(){a(this).children("input").length===0&&E(a(this))})},this.add=function(a){A(a)},this.remove=function(b){r.children("li").each(function(){if(a(this).children("input").length===0){var c=a(this).data("tokeninput"),d=!0;for(var e in b)if(b[e]!==c[e]){d=!1;break}d&&E(a(this))}})}},a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b),d={},e=0,f=function(){d={},e=0};this.add=function(a,b){e>c.max_size&&f(),d[a]||(e+=1),d[a]=b},this.get=function(a){return d[a]}}})(jQuery)